from abc import ABC, abstractmethod
import random
from typing import List, Optional


class Conta(ABC):
    def __init__(self, nome: str, agencia: str, numero: str, senha: str, saldo: float = 0.0):
        self._nome = nome
        self._agencia = agencia
        self._numero = numero
        self._senha = senha
        self._saldo = saldo
        self._extrato: List[str] = []

    @property
    def nome(self): return self._nome
    @property
    def numero(self): return self._numero
    @property
    def saldo(self): return self._saldo

    def verificar_senha(self, senha: str) -> bool:
        return self._senha == senha

    def depositar(self, valor: float):
        if valor > 0:
            self._saldo += valor
            self._extrato.append(f"Depósito: + R$ {valor:.2f}")
            print(f"Depósito de R$ {valor:.2f} realizado.")
        else:
            print("Valor deve ser positivo.")

    def ver_extrato(self):
        print(f"\n--- EXTRATO ({self.__class__.__name__}) ---")
        for item in self._extrato:
            print(item)
        print(f"Saldo Atual: R$ {self._saldo:.2f}")
        print("------------------------------")

    @abstractmethod
    def sacar(self, valor: float, senha: str) -> bool:
        pass

    def transferir(self, valor: float, conta_destino: 'Conta', senha: str):
        if self.sacar(valor, senha):
            conta_destino.depositar(valor)
            self._extrato.append(f"Transferência para {conta_destino.nome}: - R$ {valor:.2f}")
            print("Transferência concluída.")

class ContaCorrente(Conta):
    def __init__(self, nome, agencia, numero, senha, saldo=0.0, limite=1000.0): 
        super().__init__(nome, agencia, numero, senha, saldo) 
        self._limite = limite

    def sacar(self, valor: float, senha: str) -> bool:
        if not self.verificar_senha(senha):
            print("Senha incorreta.")
            return False
        
        
        if valor <= 0 or valor > (self._saldo + self._limite):
            print("Saldo ou limite insuficiente.")
            return False
        
        self._saldo -= valor
        self._extrato.append(f"Saque (CC): - R$ {valor:.2f}")
        return True

class ContaPoupanca(Conta):
    def __init__(self, nome, agencia, numero, senha, saldo=0.0): 
        super().__init__(nome, agencia, numero, senha, saldo) 

    def sacar(self, valor: float, senha: str) -> bool:
        if not self.verificar_senha(senha):
            print("Senha incorreta.")
            return False
        
        if valor <= 0 or valor > self._saldo:
            print("Saldo insuficiente na poupança.")
            return False
        
        self._saldo -= valor
        self._extrato.append(f"Saque (CP): - R$ {valor:.2f}")
        return True



class GerenciadorBanco:
    _instance = None

    def __new__(cls):
       
        if cls._instance is None:
            cls._instance = super(GerenciadorBanco, cls).__new__(cls)
            cls._instance.contas = [] 
        return cls._instance

    def gerar_numero_unico(self) -> str:
        while True:
            
            candidato = str(random.randint(10000, 99999))
            if self.buscar_conta(candidato) is None:
                return candidato

    def adicionar_conta(self, conta: Conta):
        self.contas.append(conta) 

    def buscar_conta(self, numero: str) -> Optional[Conta]:
        for c in self.contas: 
            if c.numero == numero: 
                return c 
        return None

    def listar_contas(self):
        print("\n--- Contas no Sistema ---")
        for c in self.contas: 
            tipo = "Corrente" if isinstance(c, ContaCorrente) else "Poupança"
            print(f"[{tipo}] Titular: {c.nome} | Conta: {c.numero}")

class ContaFactory:
    @staticmethod
    def criar_conta(tipo: str, nome: str, agencia: str, senha: str) -> Optional[Conta]:
        
        numero_gerado = GerenciadorBanco().gerar_numero_unico()

        if tipo == "1":
            return ContaCorrente(nome, agencia, numero_gerado, senha)
        elif tipo == "2":
            return ContaPoupanca(nome, agencia, numero_gerado, senha)
        else:
            return None

def main():
    banco = GerenciadorBanco()
    
    # Criando contas iniciais para teste
    c1 = ContaFactory.criar_conta("1", "Alice", "001", "1234")
    if c1:
        c1.depositar(1000)
        banco.adicionar_conta(c1)

    c2 = ContaFactory.criar_conta("2", "Bob", "001", "4321")
    if c2:
        c2.depositar(500)
        banco.adicionar_conta(c2)

    conta_ativa: Optional[Conta] = None

    while True:
        print("\n--- SIMULADOR BANCÁRIO OOP ---")
        if not conta_ativa:
            print("1. Criar Nova Conta")
            print("2. Login (Selecionar Conta)")
            print("3. Listar Todas as Contas (Admin)")
            print("0. Sair")
        else:
            print(f"--- Logado como: {conta_ativa.nome} ---")
            print("1. Ver Extrato")
            print("2. Depositar")
            print("3. Sacar")
            print("4. Transferir")
            print("5. Logout")

        opcao = input("Opção: ")

        if not conta_ativa:
            if opcao == "1":
                tipo = input("Tipo (1-Corrente, 2-Poupança): ")
                nome = input("Nome: ")
                senha = input("Senha: ")
                
                nova_conta = ContaFactory.criar_conta(tipo, nome, "001", senha)
                
                if nova_conta:
                    banco.adicionar_conta(nova_conta)
                    print(f"Conta criada com sucesso!")
                    print(f"ANOTE SEU NÚMERO DA CONTA: {nova_conta.numero}")
                else:
                    print("Tipo inválido.")
            
            elif opcao == "2":
                num = input("Digite o número da conta: ")
                conta = banco.buscar_conta(num)
                if conta:
                    senha = input("Senha: ")
                    if conta.verificar_senha(senha):
                        conta_ativa = conta
                    else:
                        print("Senha inválida.")
                else:
                    print("Conta não encontrada.")
            
            elif opcao == "3":
                banco.listar_contas()
            
            elif opcao == "0":
                break

        else:
            if opcao == "1":
                conta_ativa.ver_extrato()
            
            elif opcao == "2":
                try:
                    val = float(input("Valor depósito: "))
                    conta_ativa.depositar(val)
                except ValueError:
                    print("Valor inválido.")
            
            elif opcao == "3":
                try:
                    val = float(input("Valor saque: "))
                    pwd = input("Senha: ")
                    conta_ativa.sacar(val, pwd)
                except ValueError:
                    print("Valor inválido.")
            
            elif opcao == "4":
                dest_num = input("Conta destino: ")
                dest = banco.buscar_conta(dest_num)
                if dest:
                    try:
                        val = float(input("Valor: "))
                        pwd = input("Senha: ")
                        conta_ativa.transferir(val, dest, pwd)
                    except ValueError:
                        print("Valor inválido.")
                else:
                    print("Destino não encontrado.")
            
            elif opcao == "5":
                conta_ativa = None

if __name__ == "__main__":
    main()
